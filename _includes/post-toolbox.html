{% if page.layout == 'home' %}
<section id="post-toolbox" class="mt-3">
  <button 
    type="button" 
    class="panel-heading w-100 text-start border-0 bg-transparent p-0 d-flex justify-content-between align-items-center"
    onclick="toggleToolbox()"
    aria-expanded="false"
    id="toolbox-toggle"
    style="cursor: pointer;"
  >
    <h2 class="panel-heading mb-0">Toolbox</h2>
    <i class="fas fa-chevron-down" id="toolbox-icon"></i>
  </button>
  
  <div id="toolbox-content" class="content mt-3" style="display: none;">
    <!-- Filter Section -->
    <div class="mb-3">
      <label class="small text-muted mb-2 d-block">Filter by Category</label>
      <div class="d-flex flex-wrap" style="gap: 0.5rem;">
        {% assign all_categories = site.categories | sort %}
        {% for category in all_categories %}
          {% assign category_name = category | first %}
          <label class="btn btn-sm btn-outline-secondary mb-0 toolbox-checkbox" style="cursor: pointer; margin: 0;">
            <input type="checkbox" class="d-none filter-category" value="{{ category_name }}" onchange="updateFilterVisual()">
            <span>{{ category_name }}</span>
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- Sort Section -->
    <div class="mb-3">
      <label class="small text-muted mb-2 d-block">Sort by</label>
      <div class="d-flex flex-column" style="gap: 0.5rem;">
        <label class="btn btn-sm btn-outline-secondary mb-0 text-start toolbox-radio" style="cursor: pointer;">
          <input type="radio" name="sort-option" class="d-none" value="date-desc" checked onchange="updateSortVisual()">
          <span><i class="fas fa-calendar-alt me-1"></i> Newest First</span>
        </label>
        <label class="btn btn-sm btn-outline-secondary mb-0 text-start toolbox-radio" style="cursor: pointer;">
          <input type="radio" name="sort-option" class="d-none" value="date-asc" onchange="updateSortVisual()">
          <span><i class="fas fa-calendar-alt me-1"></i> Oldest First</span>
        </label>
        <label class="btn btn-sm btn-outline-secondary mb-0 text-start toolbox-radio" style="cursor: pointer;">
          <input type="radio" name="sort-option" class="d-none" value="title-asc" onchange="updateSortVisual()">
          <span><i class="fas fa-sort-alpha-down me-1"></i> Title A-Z</span>
        </label>
        <label class="btn btn-sm btn-outline-secondary mb-0 text-start toolbox-radio" style="cursor: pointer;">
          <input type="radio" name="sort-option" class="d-none" value="title-desc" onchange="updateSortVisual()">
          <span><i class="fas fa-sort-alpha-up me-1"></i> Title Z-A</span>
        </label>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex" style="gap: 0.5rem; margin-top: 1rem;">
      <button type="button" class="btn btn-sm btn-primary flex-fill" onclick="applyFilters()">
        <i class="fas fa-check me-1"></i> Apply
      </button>
      <button type="button" class="btn btn-sm btn-outline-secondary flex-fill" onclick="clearFilters()">
        <i class="fas fa-times me-1"></i> Clear
      </button>
    </div>
  </div>
</section>

<script>
(function() {
  let originalPosts = [];
  let originalOrder = [];

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    const postList = document.getElementById('post-list');
    if (postList) {
      const articles = Array.from(postList.querySelectorAll('article.card-wrapper'));
      originalPosts = articles.map((article, index) => {
        const titleEl = article.querySelector('h1.card-title');
        const dateEl = article.querySelector('time');
        const categoryLinks = article.querySelectorAll('a[href^="/categories/"]');
        // Also check for categories in the post-meta section
        const categoryText = article.querySelector('.post-meta .categories')?.textContent || '';
        const categoriesFromText = categoryText.split(',').map(c => c.trim()).filter(Boolean);
        const categoriesFromLinks = Array.from(categoryLinks).map(link => link.textContent.trim()).filter(Boolean);
        
        return {
          element: article,
          originalIndex: index,
          title: titleEl?.textContent?.trim() || '',
          date: dateEl?.getAttribute('datetime') || dateEl?.textContent?.trim() || '',
          categories: [...new Set([...categoriesFromLinks, ...categoriesFromText])],
          visible: true
        };
      });
      originalOrder = [...originalPosts];
    }
  });

  window.toggleToolbox = function() {
    const content = document.getElementById('toolbox-content');
    const icon = document.getElementById('toolbox-icon');
    const toggle = document.getElementById('toolbox-toggle');
    
    if (content.style.display === 'none') {
      content.style.display = 'block';
      icon.classList.remove('fa-chevron-down');
      icon.classList.add('fa-chevron-up');
      toggle.setAttribute('aria-expanded', 'true');
    } else {
      content.style.display = 'none';
      icon.classList.remove('fa-chevron-up');
      icon.classList.add('fa-chevron-down');
      toggle.setAttribute('aria-expanded', 'false');
    }
  };

  window.updateFilterVisual = function() {
    document.querySelectorAll('.toolbox-checkbox').forEach(label => {
      const checkbox = label.querySelector('.filter-category');
      if (checkbox.checked) {
        label.classList.add('active');
      } else {
        label.classList.remove('active');
      }
    });
  };

  window.updateSortVisual = function() {
    document.querySelectorAll('.toolbox-radio').forEach(label => {
      const radio = label.querySelector('input[name="sort-option"]');
      if (radio.checked) {
        label.classList.add('active');
      } else {
        label.classList.remove('active');
      }
    });
  };

  window.applyFilters = function() {
    const selectedCategories = Array.from(document.querySelectorAll('.filter-category:checked'))
      .map(cb => cb.value);
    const sortOption = document.querySelector('input[name="sort-option"]:checked')?.value || 'date-desc';

    const postList = document.getElementById('post-list');
    if (!postList) return;

    // Filter and sort posts
    let filteredPosts = originalPosts.map(post => {
      if (selectedCategories.length === 0) {
        post.visible = true;
      } else {
        post.visible = selectedCategories.some(cat => post.categories.includes(cat));
      }
      return post;
    }).filter(post => post.visible);

    // Sort posts
    filteredPosts.sort((a, b) => {
      switch(sortOption) {
        case 'date-desc':
          return new Date(b.date || 0) - new Date(a.date || 0);
        case 'date-asc':
          return new Date(a.date || 0) - new Date(b.date || 0);
        case 'title-asc':
          return (a.title || '').localeCompare(b.title || '');
        case 'title-desc':
          return (b.title || '').localeCompare(a.title || '');
        default:
          return 0;
      }
    });

    // Hide all posts first
    originalPosts.forEach(post => {
      post.element.style.display = 'none';
    });

    // Show and reorder filtered posts
    filteredPosts.forEach(post => {
      post.element.style.display = '';
      postList.appendChild(post.element);
    });
  };

  window.clearFilters = function() {
    // Clear checkboxes
    document.querySelectorAll('.filter-category').forEach(cb => {
      cb.checked = false;
    });
    updateFilterVisual();

    // Reset sort to default
    const defaultSort = document.querySelector('input[name="sort-option"][value="date-desc"]');
    if (defaultSort) {
      defaultSort.checked = true;
      updateSortVisual();
    }

    // Restore original posts
    const postList = document.getElementById('post-list');
    if (postList) {
      originalPosts.forEach(post => {
        post.element.style.display = '';
      });
      
      // Restore original order
      originalOrder.forEach(post => {
        postList.appendChild(post.element);
      });
    }
  };

  // Initialize sort visual state
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      updateSortVisual();
    }, 100);
  });
})();
</script>

<style>
#post-toolbox {
  margin-top: 1rem;
}

#post-toolbox .panel-heading {
  font-size: 1rem;
  font-weight: 500;
  color: var(--bs-body-color);
}

#post-toolbox .btn.active {
  background-color: var(--bs-primary);
  color: var(--bs-white);
  border-color: var(--bs-primary);
}

#post-toolbox .btn:hover:not(.active) {
  background-color: var(--bs-primary-bg-subtle);
  border-color: var(--bs-primary);
}

#post-toolbox label.btn {
  transition: all 0.2s ease;
}

#toolbox-toggle {
  cursor: pointer;
}

#toolbox-toggle:hover {
  opacity: 0.8;
}

#toolbox-content {
  padding-top: 0.5rem;
}

#post-toolbox .small {
  font-size: 0.875rem;
  color: var(--bs-secondary);
}
</style>
{% endif %}

