---
layout: post
title: "Vulnerability Management: Automating Amazon Inspector"
date: 2025-11-18 18:00:00 -0400
categories: [Vulnerability Management]
tags: [Inspector, VulnerabilityManagement, Python, Patching, AWS]
excerpt: "Patching is the most unglamorous yet critical task in cybersecurity. The window between a vulnerability disclosure and its exploitation is shrinking."
---

Patching is the most unglamorous yet critical task in cybersecurity. The window between a vulnerability disclosure and its exploitation is shrinking. Amazon Inspector can tell you what is broken, but it's up to you to fix it. Today, we will close that loop. We will script a solution that takes vulnerability findings from Inspector and automatically triggers AWS Systems Manager to apply the necessary patches to the affected instances, reducing our exposure window from days to minutes.

## CVEs and Mean Time to Remediate

The Mean Time to Remediate (MTTR) is a critical security metric. The faster you patch, the smaller your attack surface. Manual patching is slow and error-prone. Automation is the answer.

## Configuring Inspector

First, let's enable Inspector for automated scanning:

```python
import boto3

inspector2 = boto3.client('inspector2')
ssm = boto3.client('ssm')

def enable_inspector_scanning():
    """Enable Amazon Inspector for EC2 and ECR scanning."""
    
    # Enable for EC2
    inspector2.enable(
        resourceTypes=['EC2'],
        accountIds=[],  # Empty = current account
        clientToken='enable-inspector-ec2'
    )
    
    # Enable for ECR
    inspector2.enable(
        resourceTypes=['ECR'],
        accountIds=[],
        clientToken='enable-inspector-ecr'
    )
    
    print("‚úÖ Enabled Inspector scanning for EC2 and ECR")

def create_scan_configuration():
    """Create a scan configuration."""
    
    response = inspector2.create_filter(
        name='high-severity-cves',
        filterCriteria={
            'severity': {
                'comparison': 'EQUALS',
                'value': 'HIGH'
            },
            'vulnerabilityId': {
                'comparison': 'NOT_EQUALS',
                'value': ''  # All CVEs
            }
        },
        action='NONE'
    )
    
    filter_arn = response['filterArn']
    print(f"‚úÖ Created filter: {filter_arn}")
    return filter_arn
```

## The Remediation Workflow

Now let's build the automation that patches vulnerabilities:

```python
def lambda_handler(event, context):
    """Process Inspector findings and trigger patching."""
    
    finding = event['detail']
    
    # Extract finding details
    finding_arn = finding['findingArn']
    severity = finding.get('severity', 'UNKNOWN')
    instance_id = finding.get('resources', [{}])[0].get('id', '')
    cve_id = finding.get('packageVulnerabilityDetails', {}).get('vulnerabilityId', '')
    
    if not instance_id.startswith('i-'):
        print(f"Skipping non-EC2 resource: {instance_id}")
        return {'statusCode': 200}
    
    if severity in ['HIGH', 'CRITICAL']:
        print(f"üö® High severity CVE found: {cve_id} on {instance_id}")
        trigger_patching(instance_id, cve_id)
    
    return {'statusCode': 200}

def trigger_patching(instance_id, cve_id):
    """Trigger Systems Manager to patch the instance."""
    
    # Check if instance has SSM agent
    try:
        response = ssm.describe_instance_information(
            Filters=[
                {
                    'Key': 'InstanceIds',
                    'Values': [instance_id]
                }
            ]
        )
        
        if not response['InstanceInformationList']:
            print(f"‚ùå Instance {instance_id} doesn't have SSM agent")
            return
        
    except Exception as e:
        print(f"‚ùå Error checking SSM: {e}")
        return
    
    # Run patch baseline
    try:
        response = ssm.send_command(
            InstanceIds=[instance_id],
            DocumentName='AWS-RunPatchBaseline',
            Parameters={
                'Operation': ['Install'],
                'RebootOption': ['RebootIfNeeded']
            },
            Comment=f'Automated patching for CVE: {cve_id}',
            TimeoutSeconds=3600
        )
        
        command_id = response['Command']['CommandId']
        print(f"‚úÖ Triggered patching for {instance_id} (Command: {command_id})")
        
    except Exception as e:
        print(f"‚ùå Error triggering patch: {e}")
```

## Reporting

Let's add a weekly email report of findings:

```python
import boto3
from datetime import datetime, timedelta

ses = boto3.client('ses')

def generate_weekly_report():
    """Generate and email a weekly vulnerability report."""
    
    # Get findings from last week
    end_time = datetime.now()
    start_time = end_time - timedelta(days=7)
    
    paginator = inspector2.get_paginator('list_findings')
    
    findings = []
    for page in paginator.paginate(
        filterCriteria={
            'severity': {
                'comparison': 'EQUALS',
                'value': 'HIGH'
            }
        }
    ):
        findings.extend(page['findings'])
    
    # Aggregate by severity
    summary = {
        'CRITICAL': 0,
        'HIGH': 0,
        'MEDIUM': 0,
        'LOW': 0
    }
    
    for finding in findings:
        severity = finding.get('severity', 'UNKNOWN')
        summary[severity] = summary.get(severity, 0) + 1
    
    # Generate email
    email_body = f"""
    Weekly Vulnerability Report
    
    Period: {start_time.strftime('%Y-%m-%d')} to {end_time.strftime('%Y-%m-%d')}
    
    Summary:
    - Critical: {summary['CRITICAL']}
    - High: {summary['HIGH']}
    - Medium: {summary['MEDIUM']}
    - Low: {summary['LOW']}
    
    Total Findings: {len(findings)}
    """
    
    # Send email via SES
    ses.send_email(
        Source='security@example.com',
        Destination={'ToAddresses': ['team@example.com']},
        Message={
            'Subject': {'Data': 'Weekly Vulnerability Report'},
            'Body': {'Text': {'Data': email_body}}
        }
    )
    
    print("‚úÖ Sent weekly vulnerability report")
```

## Keeping the Fleet Hardened Automatically

You've built a system that:
- Scans for vulnerabilities automatically
- Triggers patching for high-severity issues
- Reports on security posture weekly

This reduces your MTTR from days to hours, significantly improving your security posture. In the next post, we'll automate IAM key rotation.

